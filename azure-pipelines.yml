name: Nodejs base images pipeline

trigger:
  batch: true
  branches:
    include:
      - master
  paths:
    exclude:
      - README.md

pr:
  - master

variables:
  azureContainerRegistry: hmcts.azurecr.io
  azureSubscriptionEndpoint: azurerm-nonprod
  vmImage: "Ubuntu-16.04"

jobs:
  - job: Build
    strategy:
      matrix:
        build-alpine-node-8:
          imageDockerfilePath: 8/alpine/Dockerfile
          imageName: hmcts/base/node/alpine-lts-8
        build-alpine-node-10:
          imageDockerfilePath: 10/alpine/Dockerfile
          imageName: hmcts/base/node/alpine-lts-10
        build-stretch-slim-node-8:
          imageDockerfilePath: 8/stretch-slim/Dockerfile
          imageName: hmcts/base/node/stretch-slim-lts-8
        build-stretch-slim-node-10:
          imageDockerfilePath: 10/stretch-slim/Dockerfile
          imageName: hmcts/base/node/stretch-slim-lts-10
    pool:
      vmImage: $(vmImage)
    steps:
      - template: steps/build.yml
        parameters:
          imageDockerfilePath: $(imageDockerfilePath)
          imageName: $(imageName)
          azureContainerRegistry: $(azureContainerRegistry)
          azureSubscriptionEndpoint: $(azureSubscriptionEndpoint)

  - job: Release
    strategy:
      matrix:
        release-alpine-node-8:
          dependsOn: build-alpine-node-8
          imageDockerfilePath: 8/alpine/Dockerfile
          imageName: hmcts/base/node/alpine-lts-8
        release-alpine-node-10:
          dependsOn: build-alpine-node-10
          imageDockerfilePath: 10/alpine/Dockerfile
          imageName: hmcts/base/node/alpine-lts-10
        release-stretch-slim-node-8:
          dependsOn: build-stretch-slim-node-8
          imageDockerfilePath: 8/stretch-slim/Dockerfile
          imageName: hmcts/base/node/stretch-slim-lts-8
        release-stretch-slim-node-10:
          dependsOn: build-stretch-slim-node-10
          imageDockerfilePath: 10/stretch-slim/Dockerfile
          imageName: hmcts/base/node/stretch-slim-lts-10
    condition: and(succeeded(), eq(variables['build.sourceBranch'], 'refs/heads/master')) # Master branch only
    pool:
      vmImage: $(vmImage)
    steps:
      - template: steps/release.yml
        parameters:
          imageName: $(imageName)
          dependsOn: $(dependsOn)
          azureContainerRegistry: $(azureContainerRegistry)
          azureSubscriptionEndpoint: $(azureSubscriptionEndpoint)
