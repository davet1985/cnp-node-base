steps:
  - task: Docker@1
    displayName: Container registry login
    inputs:
      azureSubscriptionEndpoint: ${{ parameters.azureSubscriptionEndpoint }}
      azureContainerRegistry: ${{ parameters.azureContainerRegistry }}
      command: login

  - task: Bash@3
    displayName: 'Lint Dockerfile'
    continueOnError: true
    inputs:
      azureSubscription:  'azurerm-nonprod'
      scriptLocation: 'inlineScript'
      inlineScript: |
          sudo npm install -g dockerlint
          dockerlint ${{ parameters.imageDockerfilePath }}

  - task: Docker@1
    displayName: Build image
    inputs:
      command: build
      azureSubscriptionEndpoint: ${{ parameters.azureSubscriptionEndpoint }}
      azureContainerRegistry: ${{ parameters.azureContainerRegistry }}
      dockerFile: ${{ parameters.imageDockerfilePath }}
      imageName: ${{ parameters.azureContainerRegistry }}/${{ parameters.imageName }}:$(Build.SourceVersion)

  - task: Docker@1
    displayName: Push image
    inputs:
      command: push
      azureSubscriptionEndpoint: azurerm-nonprod
      azureContainerRegistry: hmcts.azurecr.io
      imageName: ${{ parameters.azureContainerRegistry }}/${{parameters.imageName}}:$(Build.SourceVersion)
